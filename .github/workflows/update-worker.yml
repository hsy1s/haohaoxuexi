name: Auto Update Worker

on:
Â  push:
Â Â Â  branches:
Â Â Â Â Â  - main
Â  schedule:
Â Â Â  - cron: "0 1 * * *" # æ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨è¿è¡Œ
Â  workflow_dispatch:
Â Â Â  inputs:
Â Â Â Â Â  update_latest:
Â Â Â Â Â Â Â  description: 'æ˜¯å¦æ‰‹åŠ¨æ›´æ–° Latest æ­£å¼ç‰ˆï¼Ÿ'
Â Â Â Â Â Â Â  required: false
Â Â Â Â Â Â Â  default: 'false'

permissions:
Â  contents: write

jobs:
Â  update:
Â Â Â  runs-on: ubuntu-latest
Â Â Â  steps:
Â Â Â Â Â  - name: åˆå§‹åŒ–ä»“åº“
Â Â Â Â Â Â Â  uses: actions/checkout@v4

Â Â Â Â Â  - name: è·å–å½“å‰æœ¬åœ°ç‰ˆæœ¬
Â Â Â Â Â Â Â  id: get_local_version
Â Â Â Â Â Â Â  run: |
Â Â Â Â Â Â Â Â Â  if [ -f version.txt ]; then
Â Â Â Â Â Â Â Â Â Â Â  LOCAL_VERSION=$(cat version.txt)
Â Â Â Â Â Â Â Â Â  else
Â Â Â Â Â Â Â Â Â Â Â  LOCAL_VERSION=""
Â Â Â Â Â Â Â Â Â  fi
Â Â Â Â Â Â Â Â Â  echo "LOCAL_VERSION=$LOCAL_VERSION" >> $GITHUB_ENV

Â Â Â Â Â  - name: è·å–æœ€æ–° Pre-release å’Œ Latest
Â Â Â Â Â Â Â  id: get_release
Â Â Â Â Â Â Â  run: |
Â Â Â Â Â Â Â Â Â  API_URL="https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases"
Â Â Â Â Â Â Â Â Â  RESPONSE=$(curl -s "$API_URL")

Â Â Â Â Â Â Â Â Â  # æœ€æ–° Pre-release
Â Â Â Â Â Â Â Â Â  PRE_RELEASE_TAG=$(echo "$RESPONSE" | jq -r '.[] | select(.prerelease==true) | .tag_name' | head -n 1)
Â Â Â Â Â Â Â Â Â  PRE_RELEASE_DOWNLOAD=$(echo "$RESPONSE" | jq -r '.[] | select(.prerelease==true) | .assets[] | select(.name=="worker.zip") | .browser_download_url' | head -n 1)

Â Â Â Â Â Â Â Â Â  # æœ€æ–°æ­£å¼ç‰ˆ Latestï¼ˆä»…æé†’ï¼‰
Â Â Â Â Â Â Â Â Â  LATEST_TAG=$(echo "$RESPONSE" | jq -r '.[] | select(.prerelease==false) | .tag_name' | head -n 1)

Â Â Â Â Â Â Â Â Â  echo "PRE_RELEASE_TAG=$PRE_RELEASE_TAG" >> $GITHUB_ENV
Â Â Â Â Â Â Â Â Â  echo "PRE_RELEASE_DOWNLOAD=$PRE_RELEASE_DOWNLOAD" >> $GITHUB_ENV
Â Â Â Â Â Â Â Â Â  echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV

Â Â Â Â Â Â Â Â Â  echo "æœ€æ–° Pre-release: $PRE_RELEASE_TAG"
Â Â Â Â Â Â Â Â Â  echo "æœ€æ–°æ­£å¼ç‰ˆ Latest: $LATEST_TAG (ä»…æé†’)"

Â Â Â Â Â  - name: åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–° Pre-release
Â Â Â Â Â Â Â  id: check_update
Â Â Â Â Â Â Â  run: |
Â Â Â Â Â Â Â Â Â  if [ "$LOCAL_VERSION" = "$PRE_RELEASE_TAG" ]; then
Â Â Â Â Â Â Â Â Â Â Â  echo "UPDATE_NEEDED=false" >> $GITHUB_ENV
Â Â Â Â Â Â Â Â Â Â Â  echo "å·²ç»æ˜¯æœ€æ–° Pre-release ç‰ˆæœ¬"
Â Â Â Â Â Â Â Â Â  else
Â Â Â Â Â Â Â Â Â Â Â  echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
Â Â Â Â Â Â Â Â Â Â Â  echo "å‘ç°æ–° Pre-release ç‰ˆæœ¬ $PRE_RELEASE_TAG"
Â Â Â Â Â Â Â Â Â  fi

Â Â Â Â Â  - name: æ›´æ–° Pre-release
Â Â Â Â Â Â Â  if: env.UPDATE_NEEDED == 'true'
Â Â Â Â Â Â Â  run: |
Â Â Â Â Â Â Â Â Â  shopt -s extglob
Â Â Â Â Â Â Â Â Â  rm -rf !( .git )
Â Â Â Â Â Â Â Â Â  wget -O worker.zip "$PRE_RELEASE_DOWNLOAD"
Â Â Â Â Â Â Â Â Â  unzip -o worker.zip
Â Â Â Â Â Â Â Â Â  rm worker.zip
Â Â Â Â Â Â Â Â Â  echo "$PRE_RELEASE_TAG" > version.txt

Â Â Â Â Â  - name: æäº¤ Pre-release æ›´æ–°
Â Â Â Â Â Â Â  if: env.UPDATE_NEEDED == 'true'
Â Â Â Â Â Â Â  uses: stefanzweifel/git-auto-commit-action@v5
Â Â Â Â Â Â Â  with:
Â Â Â Â Â Â Â Â Â  commit_message: "ğŸ”„ è‡ªåŠ¨åŒæ­¥æœ€æ–° Pre-release Workerï¼š${{ env.PRE_RELEASE_TAG }}"
Â Â Â Â Â Â Â Â Â  commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
Â Â Â Â Â Â Â Â Â  push_options: --force

Â Â Â Â Â  - name: æ‰‹åŠ¨æ›´æ–° Latest
Â Â Â Â Â Â Â  if: ${{ github.event.inputs.update_latest == 'true' }}
Â Â Â Â Â Â Â  run: |
Â Â Â Â Â Â Â Â Â  echo "å¼€å§‹æ‰‹åŠ¨æ›´æ–° Latest æ­£å¼ç‰ˆ $LATEST_TAG"
Â Â Â Â Â Â Â Â Â  API_URL="https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases"
Â Â Â Â Â Â Â Â Â  RESPONSE=$(curl -s "$API_URL")
Â Â Â Â Â Â Â Â Â  LATEST_DOWNLOAD=$(echo "$RESPONSE" | jq -r ".[] | select(.tag_name==\"$LATEST_TAG\") | .assets[] | select(.name==\"worker.zip\") | .browser_download_url")
Â Â Â Â Â Â Â Â Â  shopt -s extglob
Â Â Â Â Â Â Â Â Â  rm -rf !( .git )
Â Â Â Â Â Â Â Â Â  wget -O worker.zip "$LATEST_DOWNLOAD"
Â Â Â Â Â Â Â Â Â  unzip -o worker.zip
Â Â Â Â Â Â Â Â Â  rm worker.zip
Â Â Â Â Â Â Â Â Â  echo "$LATEST_TAG" > version.txt
Â Â Â Â Â Â Â Â Â  git config user.name "github-actions[bot]"
Â Â Â Â Â Â Â Â Â  git config user.email "github-actions[bot]@users.noreply.github.com"
Â Â Â Â Â Â Â Â Â  git add .
Â Â Â Â Â Â Â Â Â  git commit -m "ğŸ”„ æ‰‹åŠ¨åŒæ­¥ Latest Workerï¼š$LATEST_TAG"
Â Â Â Â Â Â Â Â Â  git push --force
